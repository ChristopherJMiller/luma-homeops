---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: authelia-release
  namespace: argo-cd
spec:
  project: default
  source:
    repoURL: https://charts.authelia.com
    targetRevision: 0.9.x
    chart: authelia
    helm:
      releaseName: a
      valuesObject:
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: nginx
            external-dns.alpha.kubernetes.io/target: chrismiller.xyz
            nginx.ingress.kubernetes.io/configuration-snippet: |
              more_clear_headers "Content-Security-Policy";
          className: nginx
          rulesOverride:
            - host: auth.chrismiller.xyz
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: a-authelia
                        port:
                          number: 80
          tls:
            enabled: true
            secretName: auth-tls
        pod:
          resources:
            requests:
              cpu: 0.25
              memory: 50Mi
            limits:
              memory: 125Mi
        podDistruptionBudget:
          enabled: true
          minAvailable: 1
        telemetry:
          metrics:
            enabled: true
        configMap:
          session:
            redis:
              enabled: true
              deploy: true
          storage:
            postgres:
              enable: true
              deploy: true
        persistence:
          enabled: true
          storageClass: rook-ceph-block
        postgresql:
          primary:
            persistence:
              enabled: true
              storageClass: rook-ceph-block
              size: 10Gi
        redis:
          master:
            persistence:
              enabled: true
              storageClass: rook-ceph-block
          replica:
            persistence:
              enabled: true
              storageClass: rook-ceph-block
  destination:
    server: https://kubernetes.default.svc
    namespace: authelia
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: true
    syncOptions:
      - PrunePropagationPolicy=foreground
      - PruneLast=true
