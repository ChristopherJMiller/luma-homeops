---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: authelia-release
  namespace: argo-cd
spec:
  project: default
  source:
    repoURL: https://charts.authelia.com
    targetRevision: 0.9.x
    chart: authelia
    helm:
      releaseName: a
      valuesObject:
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: nginx
            external-dns.alpha.kubernetes.io/target: chrismiller.xyz
            nginx.ingress.kubernetes.io/configuration-snippet: |
              more_clear_headers "Content-Security-Policy";
          className: nginx
          hostOverride:
            - host: auth.chrismiller.xyz
              path: /
          tls:
            enabled: true
            secretName: auth-tls
        pod:
          resources:
            requests:
              cpu: 0.25
              memory: 50Mi
            limits:
              memory: 125Mi
        podDistruptionBudget:
          enabled: true
          minAvailable: 1
        telemetry:
          metrics:
            enabled: true
        configMap:
          session:
            cookies:
              - subdomain: auth
                domain: chrismiller.xyz
            redis:
              enabled: true
              deploy: true
              host: a-redis-master
          storage:
            postgres:
              enabled: true
              deploy: true
              address: a-postgresql
              password:
                secret_name: a-postgresql
                path: postgres-password
          notifier:
            filesystem:
              enabled: true
          authentication_backend:
            ldap:
              enabled: true
              address: ldap://ldap
              base_dn: DC=chrismiller,DC=xyz
              user: CN=Authelia,DC=chrismiller,DC=xyz
              password:
                secret_name: ldap-ltb-passwd
                path: LDAP_ADMIN_PASSWORD
        secret:
          additionalSecrets:
            a-postgresql:
              items:
                - key: postgres-password
                  path: postgres-password
            ldap-ltb-passwd:
              items:
                - key: LDAP_ADMIN_PASSWORD
                  path: LDAP_ADMIN_PASSWORD
        persistence:
          enabled: false
        postgresql:
          primary:
            persistence:
              enabled: true
              storageClass: rook-ceph-block
              size: 10Gi
        redis:
          master:
            persistence:
              enabled: true
              storageClass: rook-ceph-block
          replica:
            persistence:
              enabled: true
              storageClass: rook-ceph-block
  destination:
    server: https://kubernetes.default.svc
    namespace: authelia
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: true
    syncOptions:
      - PrunePropagationPolicy=foreground
      - PruneLast=true
