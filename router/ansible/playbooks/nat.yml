---
# VyOS NAT Configuration Tasks
- name: Configure destination NAT rules
  vyos.vyos.vyos_config:
    lines:
      - "set nat destination rule {{ item.rule }} description '{{ item.description }}'"
      - "set nat destination rule {{ item.rule }} destination port '{{ item.port }}'"
      - "set nat destination rule {{ item.rule }} inbound-interface name '{{ item.inbound_interface }}'"
      - "set nat destination rule {{ item.rule }} protocol '{{ item.protocol }}'"
      - "set nat destination rule {{ item.rule }} translation address '{{ item.translation_address }}'"
      - "set nat destination rule {{ item.rule }} translation port '{{ item.translation_port }}'"
    save: false
  loop: "{{ nat.destination_rules }}"
  when: not item.destination_address is defined
  tags: [nat, destination]

- name: Configure destination NAT rules with specific destination address
  vyos.vyos.vyos_config:
    lines:
      - "set nat destination rule {{ item.rule }} description '{{ item.description }}'"
      - "set nat destination rule {{ item.rule }} destination address '{{ item.destination_address }}'"
      - "set nat destination rule {{ item.rule }} destination port '{{ item.port }}'"
      - "set nat destination rule {{ item.rule }} inbound-interface name '{{ item.inbound_interface }}'"
      - "set nat destination rule {{ item.rule }} protocol '{{ item.protocol }}'"
      - "set nat destination rule {{ item.rule }} translation address '{{ item.translation_address }}'"
      - "set nat destination rule {{ item.rule }} translation port '{{ item.translation_port }}'"
    save: false
  loop: "{{ nat.destination_rules }}"
  when: item.destination_address is defined
  tags: [nat, destination]

- name: Configure source NAT rules (masquerade)
  vyos.vyos.vyos_config:
    lines:
      - "set nat source rule {{ item.rule }} outbound-interface name '{{ item.outbound_interface }}'"
      - "set nat source rule {{ item.rule }} source address '{{ item.source_address }}'"
      - "set nat source rule {{ item.rule }} translation address '{{ item.translation }}'"
    save: false
  loop: "{{ nat.source_rules }}"
  when: not item.description is defined and not item.protocol is defined
  tags: [nat, source]

- name: Configure source NAT rules with description and protocol
  vyos.vyos.vyos_config:
    lines:
      - "set nat source rule {{ item.rule }} description '{{ item.description }}'"
      - "set nat source rule {{ item.rule }} destination address '{{ item.destination_address }}'"
      - "set nat source rule {{ item.rule }} outbound-interface name '{{ item.outbound_interface }}'"
      - "set nat source rule {{ item.rule }} protocol '{{ item.protocol }}'"
      - "set nat source rule {{ item.rule }} source address '{{ item.source_address }}'"
      - "set nat source rule {{ item.rule }} translation address '{{ item.translation }}'"
    save: false
  loop: "{{ nat.source_rules }}"
  when: item.description is defined and item.protocol is defined
  tags: [nat, source]