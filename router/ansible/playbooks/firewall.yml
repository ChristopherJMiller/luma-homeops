---
# VyOS Firewall Configuration Tasks
- name: Configure firewall global options and groups (using vyos_config)
  vyos.vyos.vyos_config:
    lines:
      # Global options
      - set firewall global-options state-policy established action 'accept'
      - set firewall global-options state-policy invalid action 'drop'
      - set firewall global-options state-policy related action 'accept'
      # Interface groups
      - set firewall group interface-group LAN interface 'eth2'
      - set firewall group interface-group WAN interface 'eth0'
      # Network groups
      - set firewall group network-group NET-INSIDE-v4 network '192.168.0.0/24'
    save: false
  tags: [firewall, global, groups]

- name: Configure IPv4 input and forward filter rules
  vyos.vyos.vyos_config:
    lines:
      # Input filter default action and rules
      - set firewall ipv4 input filter default-action 'drop'
      - set firewall ipv4 input filter rule 20 action 'jump'
      - set firewall ipv4 input filter rule 20 destination port '22'
      - set firewall ipv4 input filter rule 20 jump-target 'VyOS_MANAGEMENT'
      - set firewall ipv4 input filter rule 20 protocol 'tcp'
      - set firewall ipv4 input filter rule 30 action 'accept'
      - set firewall ipv4 input filter rule 30 icmp type-name 'echo-request'
      - set firewall ipv4 input filter rule 30 protocol 'icmp'
      - set firewall ipv4 input filter rule 30 state 'new'
      - set firewall ipv4 input filter rule 40 action 'accept'
      - set firewall ipv4 input filter rule 40 destination port '53'
      - set firewall ipv4 input filter rule 40 protocol 'tcp_udp'
      - set firewall ipv4 input filter rule 40 source group network-group 'NET-INSIDE-v4'
      - set firewall ipv4 input filter rule 50 action 'accept'
      - set firewall ipv4 input filter rule 50 source address '127.0.0.0/8'
      - set firewall ipv4 input filter rule 60 action 'accept'
      - set firewall ipv4 input filter rule 60 destination port '8585'
      - set firewall ipv4 input filter rule 60 protocol 'tcp'
      - set firewall ipv4 input filter rule 60 source group network-group 'NET-INSIDE-v4'
      # Forward filter rules
      - set firewall ipv4 forward filter rule 100 action 'jump'
      - set firewall ipv4 forward filter rule 100 destination group network-group 'NET-INSIDE-v4'
      - set firewall ipv4 forward filter rule 100 inbound-interface group 'WAN'
      - set firewall ipv4 forward filter rule 100 jump-target 'OUTSIDE-IN'
    save: false
  tags: [firewall, input, forward]

- name: Configure custom firewall chains (using vyos_config for complex rules)
  vyos.vyos.vyos_config:
    lines:
      # OUTSIDE-IN chain
      - set firewall ipv4 name OUTSIDE-IN default-action 'drop'
      - set firewall ipv4 name OUTSIDE-IN rule 10 action 'accept'
      - set firewall ipv4 name OUTSIDE-IN rule 10 destination port '80'
      - set firewall ipv4 name OUTSIDE-IN rule 10 inbound-interface group 'WAN'
      - set firewall ipv4 name OUTSIDE-IN rule 10 protocol 'tcp_udp'
      - set firewall ipv4 name OUTSIDE-IN rule 20 action 'accept'
      - set firewall ipv4 name OUTSIDE-IN rule 20 destination port '443'
      - set firewall ipv4 name OUTSIDE-IN rule 20 inbound-interface group 'WAN'
      - set firewall ipv4 name OUTSIDE-IN rule 20 protocol 'tcp_udp'
      # VyOS_MANAGEMENT chain
      - set firewall ipv4 name VyOS_MANAGEMENT default-action 'return'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 15 action 'accept'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 15 inbound-interface group 'LAN'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 20 action 'drop'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 20 inbound-interface group 'WAN'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 20 recent count '4'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 20 recent time 'minute'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 20 state 'new'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 21 action 'accept'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 21 inbound-interface group 'WAN'
      - set firewall ipv4 name VyOS_MANAGEMENT rule 21 state 'new'
    save: false
  tags: [firewall, chains]